syntax = "proto3";
package audit.v1;

option go_package = "kvservice/pkg/gen/v1/audit;auditv1";

import "v1/options/options.proto";
import "v1/options/repl.proto";

// ─────────────────────────────────────────────────────────────────────────────
// AuditService — immutable append-only event log
// ─────────────────────────────────────────────────────────────────────────────

service AuditService {

  // ── Bootstrap ─────────────────────────────────────────────────────────────
  rpc ListActors(ListActorsRequest) returns (ListActorsResponse) {
    option (repl.v1.method_opts) = {
      bootstrap: true
      display:   { mode: DISPLAY_SILENT }
    };
  }

  // Seeds event_id completion for audit.get
  rpc ListEventIds(ListEventIdsRequest) returns (ListEventIdsResponse) {
    option (repl.v1.method_opts) = {
      bootstrap: true
      display:   { mode: DISPLAY_SILENT }
    };
  }

  // ── audit.stream ──────────────────────────────────────────────────────────
  rpc StreamEvents(StreamEventsRequest) returns (stream AuditEvent) {
    option (repl.v1.method_opts) = {
      cmd:         "audit.stream"
      description: "Stream live audit events"
      aliases:     "tail"
      display: {
        mode:             DISPLAY_STREAM
        columns:          "timestamp"
        columns:          "actor"
        columns:          "action"
        columns:          "service"
        columns:          "resource_id"
        columns:          "raw_payload"
        stream_separator: "─"
      }
    };
  }

  // ── audit.stream.user ─────────────────────────────────────────────────────
  // filters: neq — SYSTEM actor excluded from --actor completion dropdown.
  rpc StreamUserEvents(StreamEventsRequest) returns (stream AuditEvent) {
    option (repl.v1.method_opts) = {
      cmd:         "audit.stream.user"
      description: "Stream events for a specific actor (no SYSTEM events)"
      completions: {
        field:            "actor"
        source_rpc:       "audit.v1.AuditService.ListActors"
        source_field:     "actors"
        value_field:      "name"
        show_headers:     true
        column_separator: "  │  "
        display_fields: { path: "name"  label: "actor"  width: 16 }
        display_fields: { path: "type"  label: "type"   width: 8  }
        filters: { field: "type"  neq: "system" }
      }
      display: {
        mode:             DISPLAY_STREAM
        columns:          "timestamp"
        columns:          "action"
        columns:          "service"
        columns:          "resource_id"
        stream_separator: "─"
      }
    };
  }

  // ── audit.get ─────────────────────────────────────────────────────────────
  // --event_id completion comes from the ListEventIds bootstrap.
  // expand_nested: true — Action sub-message fields shown as action.verb / action.target.
  rpc GetEvent(GetEventRequest) returns (AuditEvent) {
    option (repl.v1.method_opts) = {
      cmd:         "audit.get"
      description: "Fetch a single audit event by ID"
      completions: {
        field:        "event_id"
        source_rpc:   "audit.v1.AuditService.ListEventIds"
        source_field: "event_ids"
      }
      display: {
        mode:          DISPLAY_KV
        expand_nested: true
      }
    };
  }

  // ── audit.search ──────────────────────────────────────────────────────────
  // --limit has int_completion_start/end/step for range tab-completion.
  // filters: present — completion requires actor.type to be non-empty.
  rpc SearchEvents(SearchEventsRequest) returns (SearchEventsResponse) {
    option (repl.v1.method_opts) = {
      cmd:         "audit.search"
      description: "Search events by actor"
      completions: {
        field:        "actor"
        source_rpc:   "audit.v1.AuditService.ListActors"
        source_field: "actors"
        value_field:  "name"
        filters: { field: "type"  present: true }
      }
      display: {
        mode:    DISPLAY_TABLE
        columns: "timestamp"
        columns: "actor"
        columns: "action"
        columns: "service"
        columns: "metadata"
      }
    };
  }
}

// ── Messages ──────────────────────────────────────────────────────────────────

message ListActorsRequest  {}
message ListActorsResponse { repeated Actor actors = 1; }

// Bootstrap: returns every known event_id for audit.get --event_id <TAB>
message ListEventIdsRequest  {}
message ListEventIdsResponse { repeated string event_ids = 1; }

// Actor candidate row. "type" drives neq/present filters.
message Actor {
  string name = 1;
  string type = 2; // "human" | "service" | "system"
}

// Action sub-message. With expand_nested:true in audit.get renders as:
//   action.verb    DELETE
//   action.target  /api/keys/bar
message Action {
  string verb   = 1;
  string target = 2;
}

message AuditEvent {
  // hidden:true — suppressed in DISPLAY_TABLE/STREAM but visible in DISPLAY_KV.
  string internal_id  = 1 [(repl.v1.field_opts) = { hidden: true }];

  int64  timestamp    = 2 [(repl.v1.field_opts) = {
    label:        "time"
    renderer:     CELL_TIMESTAMP
    column_width: 19
  }];
  string actor        = 3 [(repl.v1.field_opts) = { column_width: 16 }];
  Action action       = 4 [(repl.v1.field_opts) = { label: "action"  renderer: CELL_JSON }];
  string service      = 5 [(repl.v1.field_opts) = { column_width: 24 }];
  string resource_id  = 6 [(repl.v1.field_opts) = { label: "resource"  column_width: 20 }];
  bytes  raw_payload  = 7 [(repl.v1.field_opts) = { label: "payload"  renderer: CELL_BYTES  column_width: 20 }];
  string metadata     = 8 [(repl.v1.field_opts) = { label: "metadata" renderer: CELL_JSON   column_width: 40 }];
}

message StreamEventsRequest {
  string service = 1;
  string actor   = 2;
}

message GetEventRequest { string event_id = 1; }

message SearchEventsRequest {
  string actor = 1;
  // int_completion_end > 0 enables tab-completion: 10, 25, 50, 100
  int32  limit = 2 [(repl.v1.field_opts) = {
    int_completion_start: 10
    int_completion_end:   100
    int_completion_step:  25
  }];
}
message SearchEventsResponse { repeated AuditEvent events = 1; }